<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç”»é¢ç·¨é›†</title>
  <style>
    /* ãƒªã‚»ãƒƒãƒˆã¨ãƒ™ãƒ¼ã‚¹ã‚¹ã‚¿ã‚¤ãƒ« */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: #1a1a1a;
      color: #ffffff;
      font-family: 'Segoe UI', 'Meiryo', sans-serif;
      font-size: 14px;
      line-height: 1.5;
    }

    /* Sidebar ã‚¹ã‚¿ã‚¤ãƒ« */
    .sidebar {
      position: fixed;
      left: 0;
      top: 0;
      width: 220px;
      height: 100vh;
      background: #2a2a2a;
      border-right: 1px solid #3a3a3a;
      overflow-y: auto;
      z-index: 100;
    }

    .sidebar-header {
      padding: 20px;
      border-bottom: 1px solid #3a3a3a;
      background: #323232;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .sidebar-title {
      font-size: 18px;
      font-weight: 600;
      color: #ff8c42;
    }

    .close-button {
      background: #dc3545;
      color: white;
      border: none;
      padding: 6px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
    }

    .close-button:hover {
      background: #c82333;
    }

    .sidebar-content {
      padding: 16px;
    }

    .business-item {
      margin-bottom: 16px;
    }

    .business-title {
      font-size: 16px;
      font-weight: 600;
      color: #e0e0e0;
      margin-bottom: 8px;
      padding: 8px 12px;
      background: #3a3a3a;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .business-title:hover {
      background: #404040;
    }

    .business-title.expanded {
      background: #404040;
      color: #ff8c42;
    }

    .buc-list {
      margin-left: 16px;
      display: none;
    }

    .buc-list.expanded {
      display: block;
    }

    .buc-item {
      margin-bottom: 8px;
    }

    .buc-title {
      font-size: 14px;
      color: #e0e0e0;
      padding: 6px 10px;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .buc-title:hover {
      background: #404040;
      color: #ff8c42;
    }

    .buc-title.selected {
      background: #ff8c42;
      color: #ffffff;
    }

    /* Panel ã‚¹ã‚¿ã‚¤ãƒ« */
    .panel {
      background: #2a2a2a;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      border: 2px solid #3a3a3a;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 2px solid #404040;
    }

    .panel-title {
      font-size: 20px;
      font-weight: 600;
      color: #ff8c42;
      padding: 8px 16px;
      background: #404040;
      border-radius: 8px;
      border: 1px solid #555;
    }

    /* Card ã‚¹ã‚¿ã‚¤ãƒ« */
    .card {
      background: #323232;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
      border: 2px solid #404040;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }

    .card:hover {
      border-color: #ff8c42;
      box-shadow: 0 4px 16px rgba(255,140,66,0.2);
      transform: translateY(-2px);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding: 12px 16px;
      border-bottom: 2px solid #404040;
      background: linear-gradient(135deg, #404040 0%, #505050 100%);
      border-radius: 8px;
      border: 1px solid #555;
    }

    .card-title {
      font-size: 18px;
      font-weight: 600;
      color: #ffffff;
      text-shadow: 0 1px 2px rgba(0,0,0,0.3);
    }

    .card-actions {
      display: flex;
      gap: 8px;
    }

    /* ç”»é¢ã‚°ãƒªãƒƒãƒ‰ */
    .screens-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-top: 16px;
      width: 100%;
    }

    .screen-card {
      background: #323232;
      border-radius: 8px;
      padding: 12px;
      border: 2px solid #404040;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      width: 100%;
      box-sizing: border-box;
    }

    .screen-card:hover {
      border-color: #ff8c42;
      box-shadow: 0 4px 16px rgba(255,140,66,0.2);
      transform: translateY(-2px);
    }

    .screen-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      padding: 6px 10px;
      background: linear-gradient(135deg, #ff8c42 0%, #ffa95c 100%);
      border-radius: 6px;
      border: 1px solid #e67e22;
      box-shadow: 0 2px 4px rgba(255,140,66,0.3);
      min-height: 32px;
    }

    .screen-title {
      font-size: 14px;
      font-weight: 600;
      color: #ffffff;
      text-shadow: 0 1px 2px rgba(0,0,0,0.3);
    }

    .screen-actions {
      display: flex;
      gap: 4px;
    }

    /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
    .main-content {
      margin-left: 220px;
      padding: 24px;
      min-height: 100vh;
      background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
      width: calc(100vw - 220px);
      box-sizing: border-box;
    }

    .content-header {
      margin-bottom: 32px;
      padding: 20px;
      background: #2a2a2a;
      border-radius: 12px;
      border: 2px solid #3a3a3a;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    .content-title {
      font-size: 28px;
      font-weight: 600;
      color: #ffffff;
      margin-bottom: 8px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }

    .content-subtitle {
      color: #e0e0e0;
      font-size: 16px;
    }

    /* Tabs ã‚¹ã‚¿ã‚¤ãƒ« */
    .tabs {
      display: flex;
      border-bottom: 1px solid #3a3a3a;
      margin-bottom: 24px;
      background: #2a2a2a;
      border-radius: 8px 8px 0 0;
    }

    .tab {
      padding: 12px 24px;
      cursor: pointer;
      color: #e0e0e0;
      background: transparent;
      border: none;
      border-bottom: 2px solid transparent;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
      position: relative;
    }

    .tab:hover {
      background: #3a3a3a;
      color: #ffffff;
    }

    .tab.active {
      color: #ff8c42;
      border-bottom: 2px solid #ff8c42;
      background: #3a3a3a;
    }

    /* Button ã‚¹ã‚¿ã‚¤ãƒ« */
    .btn {
      background: #ff8c42;
      color: #ffffff;
      border: none;
      border-radius: 6px;
      padding: 8px 16px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn:hover {
      background: #ffa95c;
    }

    .btn-secondary {
      background: #404040;
      color: #e0e0e0;
    }

    .btn-secondary:hover {
      background: #505050;
    }

    .btn-danger {
      background: #dc3545;
      color: #ffffff;
    }

    .btn-danger:hover {
      background: #e74c3c;
    }

    .btn-success {
      background: #28a745;
      color: #ffffff;
    }

    .btn-success:hover {
      background: #2ecc71;
    }

    .btn-sm {
      padding: 3px 6px;
      font-size: 11px;
      height: 24px;
    }

    /* Form è¦ç´  */
    .form-group {
      margin-bottom: 12px;
    }

    .form-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
      padding: 8px;
      background: linear-gradient(135deg, #3a3a3a 0%, #404040 100%);
      border-radius: 6px;
      border: 1px solid #555;
      transition: all 0.3s ease;
      min-height: 40px;
    }

    .form-row:hover {
      background: linear-gradient(135deg, #404040 0%, #454545 100%);
      border-color: #666;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }

    .form-label {
      min-width: 100px;
      color: #e0e0e0;
      font-size: 13px;
      font-weight: 500;
    }

    .form-input {
      background: #404040;
      color: #ffffff;
      border: 1px solid #555;
      border-radius: 4px;
      padding: 4px 8px;
      font-size: 13px;
      min-width: 120px;
      height: 28px;
      transition: border-color 0.2s;
    }

    .form-input:focus {
      outline: none;
      border-color: #ff8c42;
    }

    .form-select {
      background: #404040;
      color: #ffffff;
      border: 1px solid #555;
      border-radius: 4px;
      padding: 4px 8px;
      font-size: 13px;
      min-width: 100px;
      height: 28px;
      cursor: pointer;
    }

    .form-select:focus {
      outline: none;
      border-color: #ff8c42;
    }

    .form-tooltip {
      color: #999;
      font-size: 11px;
      margin-left: 6px;
      font-style: italic;
    }

    /* ã‚¢ã‚¤ã‚³ãƒ³ */
    .icon {
      width: 16px;
      height: 16px;
      display: inline-block;
    }

    .icon-delete::before {
      content: "ğŸ—‘";
    }

    .icon-add::before {
      content: "â•";
    }

    .icon-edit::before {
      content: "âœ";
    }

    .icon-save::before {
      content: "ğŸ’¾";
    }

    /* ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ */
    .flex {
      display: flex;
    }

    .flex-col {
      flex-direction: column;
    }

    .items-center {
      align-items: center;
    }

    .justify-between {
      justify-content: space-between;
    }

    .gap-2 {
      gap: 8px;
    }

    .gap-4 {
      gap: 16px;
    }

    .mb-4 {
      margin-bottom: 16px;
    }

    .hidden {
      display: none;
    }

    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
    @media (max-width: 1200px) {
      .screens-grid {
        grid-template-columns: 1fr 1fr;
      }
    }

    @media (max-width: 768px) {
      .sidebar {
        width: 100%;
        height: auto;
        position: relative;
      }
      
      .main-content {
        margin-left: 0;
        padding: 16px;
        width: 100vw;
      }
      
      .screens-grid {
        grid-template-columns: 1fr;
      }
      
      .form-row {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .form-label {
        min-width: auto;
      }

      .panel {
        padding: 16px;
      }

      .card {
        padding: 16px;
      }

      .screen-card {
        padding: 12px;
      }
    }

    /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    .fade-in {
      animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #2a2a2a;
    }

    ::-webkit-scrollbar-thumb {
      background: #555;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #666;
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-title">æ¥­å‹™/BUC</div>
      <button class="close-button" onclick="closeAndStopServer()">é–‰ã˜ã‚‹</button>
    </div>
    <div class="sidebar-content" id="sidebarContent">
      <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®å†…å®¹ã¯JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
    </div>
  </div>

  <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
  <div class="main-content">
    <div class="content-header">
      <h1 class="content-title">ç”»é¢ç·¨é›†</h1>
    </div>

    <!-- Tabs -->
    <div class="tabs" id="tabs">
      <!-- ã‚¿ãƒ–ã¯JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
    </div>

    <!-- Panels -->
    <div id="panels">
      <!-- ãƒ‘ãƒãƒ«ã¯JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
    </div>

    <!-- ä¿å­˜ãƒœã‚¿ãƒ³ -->
    <div class="panel">
      <div class="flex justify-between items-center">
        <div>
          <h3 class="panel-title">ãƒ‡ãƒ¼ã‚¿ä¿å­˜</h3>
          <p style="color: #e0e0e0; font-size: 14px; margin-top: 4px;">
            å¤‰æ›´å†…å®¹ã‚’ui.jsonãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã—ã¾ã™
          </p>
        </div>
        <button class="btn btn-success" onclick="saveData()">
          <span class="icon icon-save"></span>
          ä¿å­˜
        </button>
      </div>
    </div>
  </div>

  <script>
    let uiData = {};
    let entitiesData = [];
    let currentBUC = null;

    // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    async function loadData() {
      try {
        // ui.jsonãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
        const uiResponse = await fetch('/api/ui');
        if (!uiResponse.ok) {
          throw new Error('ui.jsonã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
        uiData = await uiResponse.json();
        
        // ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿
        const entitiesResponse = await fetch('/api/entities');
        if (entitiesResponse.ok) {
          entitiesData = await entitiesResponse.json();
        }
                
        renderSidebar();
        renderTabs();
        renderPanels();
      } catch (error) {
        console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        alert('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      }
    }

    // ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®æç”»
    function renderSidebar() {
      const sidebarContent = document.getElementById('sidebarContent');
      sidebarContent.innerHTML = '';

      uiData.businesses.forEach(business => {
        const businessDiv = document.createElement('div');
        businessDiv.className = 'business-item';

        const businessTitle = document.createElement('div');
        businessTitle.className = 'business-title';
        businessTitle.textContent = business.business_name;
        businessTitle.onclick = () => toggleBusiness(businessTitle, businessDiv);

        const bucList = document.createElement('div');
        bucList.className = 'buc-list';

        business.BUCs.forEach(buc => {
          const bucItem = document.createElement('div');
          bucItem.className = 'buc-item';

          const bucTitle = document.createElement('div');
          bucTitle.className = 'buc-title';
          bucTitle.textContent = buc.buc_name;
          bucTitle.onclick = () => selectBUC(buc, bucTitle);

          bucItem.appendChild(bucTitle);
          bucList.appendChild(bucItem);
        });

        businessDiv.appendChild(businessTitle);
        businessDiv.appendChild(bucList);
        sidebarContent.appendChild(businessDiv);
      });
    }

    // ãƒ“ã‚¸ãƒã‚¹ã®å±•é–‹/æŠ˜ã‚ŠãŸãŸã¿
    function toggleBusiness(titleElement, businessDiv) {
      const bucList = businessDiv.querySelector('.buc-list');
      const isExpanded = bucList.classList.contains('expanded');
      
      if (isExpanded) {
        bucList.classList.remove('expanded');
        titleElement.classList.remove('expanded');
      } else {
        bucList.classList.add('expanded');
        titleElement.classList.add('expanded');
      }
    }

    // BUCã®é¸æŠ
    function selectBUC(buc, titleElement) {
      // æ—¢å­˜ã®é¸æŠã‚’ã‚¯ãƒªã‚¢
      document.querySelectorAll('.buc-title').forEach(el => {
        el.classList.remove('selected');
      });
      
      // æ–°ã—ã„é¸æŠã‚’è¨­å®š
      titleElement.classList.add('selected');
      currentBUC = buc;
      
      renderTabs();
      renderPanels();
    }

    // ã‚¿ãƒ–ã®æç”»
    function renderTabs() {
      const tabsContainer = document.getElementById('tabs');
      tabsContainer.innerHTML = '';

      if (!currentBUC) {
        tabsContainer.innerHTML = '<div style="padding: 20px; color: #e0e0e0;">ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‹ã‚‰BUCã‚’é¸æŠã—ã¦ãã ã•ã„</div>';
        return;
      }

      currentBUC.actors.forEach((actor, index) => {
        const tab = document.createElement('button');
        tab.className = 'tab' + (index === 0 ? ' active' : '');
        tab.textContent = actor.actor_name;
        tab.onclick = () => switchTab(index);
        tabsContainer.appendChild(tab);
      });
    }

    // ãƒ‘ãƒãƒ«ã®æç”»
    function renderPanels() {
      const panelsContainer = document.getElementById('panels');
      panelsContainer.innerHTML = '';

      if (!currentBUC) {
        return;
      }

      currentBUC.actors.forEach((actor, actorIndex) => {
        const panel = document.createElement('div');
        panel.className = 'panel' + (actorIndex === 0 ? '' : ' hidden');
        panel.id = `panel-${actorIndex}`;

        const panelHeader = document.createElement('div');
        panelHeader.className = 'panel-header';
        panelHeader.innerHTML = `
          <h4 class="panel-title">${actor.actor_name}</h3>
          <button class="btn btn-secondary btn-sm" onclick="addScreen(${actorIndex})">
            <span class="icon icon-add"></span>
            ç”»é¢è¿½åŠ 
          </button>
        `;

        const screensContainer = document.createElement('div');
        screensContainer.className = 'screens-grid';

        // ç”»é¢ã‚’ç›´æ¥screens-gridã«é…ç½®
        actor.screens.forEach((screen, screenIndex) => {
          const card = createScreenCard(screen, actorIndex, screenIndex);
          screensContainer.appendChild(card);
        });

        panel.appendChild(panelHeader);
        panel.appendChild(screensContainer);
        panelsContainer.appendChild(panel);
      });
    }

    // ç”»é¢ã‚«ãƒ¼ãƒ‰ã®ä½œæˆ
    function createScreenCard(screen, actorIndex, screenIndex) {
      const card = document.createElement('div');
      card.className = 'screen-card fade-in';

      const cardHeader = document.createElement('div');
      cardHeader.className = 'screen-header';
      cardHeader.innerHTML = `
        <input type="text" class="screen-title" value="${screen.screen_name}" 
               onchange="updateScreenName(${actorIndex}, ${screenIndex}, this.value)"
               style="background: transparent; border: none; color: #ffffff; font-size: 14px; font-weight: 600; text-shadow: 0 1px 2px rgba(0,0,0,0.3); flex: 1;">
        <div class="screen-actions">
          <button class="btn btn-secondary btn-sm" onclick="addField(${actorIndex}, ${screenIndex})">
            <span class="icon icon-add"></span>
            é …ç›®è¿½åŠ 
          </button>
          <button class="btn btn-danger btn-sm" onclick="deleteScreen(${actorIndex}, ${screenIndex})">
            <span class="icon icon-delete"></span>
            å‰Šé™¤
          </button>
        </div>
      `;

      const fieldsContainer = document.createElement('div');
      fieldsContainer.className = 'fields-container';

      // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æƒ…å ±ã®è¡¨ç¤º
      if (screen.fields && screen.fields.length > 0) {
        const fieldsTitle = document.createElement('div');
        fieldsTitle.className = 'form-label';
        fieldsTitle.style.marginBottom = '8px';
        fieldsTitle.style.color = '#ff8c42';
        fieldsTitle.style.fontWeight = '600';
        fieldsTitle.textContent = 'ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰:';
        fieldsContainer.appendChild(fieldsTitle);

        screen.fields.forEach((field, fieldIndex) => {
          const fieldRow = createFieldRow(field, actorIndex, screenIndex, fieldIndex);
          fieldsContainer.appendChild(fieldRow);
        });
      }

      // æ“ä½œæƒ…å ±ã®ç·¨é›†
      const operationsTitle = document.createElement('div');
      operationsTitle.className = 'form-label';
      operationsTitle.style.marginTop = '16px';
      operationsTitle.style.marginBottom = '8px';
      operationsTitle.style.color = '#28a745';
      operationsTitle.style.fontWeight = '600';
      operationsTitle.style.display = 'flex';
      operationsTitle.style.justifyContent = 'space-between';
      operationsTitle.style.alignItems = 'center';
      operationsTitle.innerHTML = `
        æ“ä½œ:
        <button class="btn btn-secondary btn-sm" onclick="addOperation(${actorIndex}, ${screenIndex})">
          <span class="icon icon-add"></span>
          æ“ä½œè¿½åŠ 
        </button>
      `;
      fieldsContainer.appendChild(operationsTitle);

      // æ“ä½œé …ç›®ãŒãªã„å ´åˆã¯ç©ºã®é…åˆ—ã‚’åˆæœŸåŒ–
      if (!screen.operations) {
        screen.operations = [];
      }

      screen.operations.forEach((operation, operationIndex) => {
        const operationRow = document.createElement('div');
        operationRow.className = 'form-row';
        operationRow.innerHTML = `
          <div class="form-group">
            <select class="form-select" onchange="updateOperation(${actorIndex}, ${screenIndex}, ${operationIndex}, this.value)">
              <option value="">æ“ä½œã‚’é¸æŠ</option>
              <option value="ç™»éŒ²" ${operation === 'ç™»éŒ²' ? 'selected' : ''}>ç™»éŒ²</option>
              <option value="æ›´æ–°" ${operation === 'æ›´æ–°' ? 'selected' : ''}>æ›´æ–°</option>
              <option value="å‰Šé™¤" ${operation === 'å‰Šé™¤' ? 'selected' : ''}>å‰Šé™¤</option>
              <option value="ç…§ä¼š" ${operation === 'ç…§ä¼š' ? 'selected' : ''}>ç…§ä¼š</option>
              <option value="ç¢ºèª" ${operation === 'ç¢ºèª' ? 'selected' : ''}>ç¢ºèª</option>
              <option value="æ‰¿èª" ${operation === 'æ‰¿èª' ? 'selected' : ''}>æ‰¿èª</option>
              <option value="å´ä¸‹" ${operation === 'å´ä¸‹' ? 'selected' : ''}>å´ä¸‹</option>
              <option value="æ¤œç´¢" ${operation === 'æ¤œç´¢' ? 'selected' : ''}>æ¤œç´¢</option>
              <option value="å°åˆ·" ${operation === 'å°åˆ·' ? 'selected' : ''}>å°åˆ·</option>
              <option value="ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ" ${operation === 'ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ' ? 'selected' : ''}>ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</option>
              <option value="ã‚¤ãƒ³ãƒãƒ¼ãƒˆ" ${operation === 'ã‚¤ãƒ³ãƒãƒ¼ãƒˆ' ? 'selected' : ''}>ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</option>
              <option value="è¨ˆç®—" ${operation === 'è¨ˆç®—' ? 'selected' : ''}>è¨ˆç®—</option>
              <option value="é›†è¨ˆ" ${operation === 'é›†è¨ˆ' ? 'selected' : ''}>é›†è¨ˆ</option>
              <option value="åˆ†æ" ${operation === 'åˆ†æ' ? 'selected' : ''}>åˆ†æ</option>
              <option value="é€šçŸ¥" ${operation === 'é€šçŸ¥' ? 'selected' : ''}>é€šçŸ¥</option>
              <option value="é€ä¿¡" ${operation === 'é€ä¿¡' ? 'selected' : ''}>é€ä¿¡</option>
              <option value="ãã®ä»–" ${!['ç™»éŒ²','æ›´æ–°','å‰Šé™¤','ç…§ä¼š','ç¢ºèª','æ‰¿èª','å´ä¸‹','æ¤œç´¢','å°åˆ·','ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ','ã‚¤ãƒ³ãƒãƒ¼ãƒˆ','è¨ˆç®—','é›†è¨ˆ','åˆ†æ','é€šçŸ¥','é€ä¿¡'].includes(operation) ? 'selected' : ''}>ãã®ä»–</option>
            </select>
          </div>
          <button class="btn btn-danger btn-sm" onclick="deleteOperation(${actorIndex}, ${screenIndex}, ${operationIndex})">
            <span class="icon icon-delete"></span>
          </button>
        `;
        fieldsContainer.appendChild(operationRow);
      });

      // ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹æƒ…å ±ã®ç·¨é›†
      const dataAccessTitle = document.createElement('div');
      dataAccessTitle.className = 'form-label';
      dataAccessTitle.style.marginTop = '16px';
      dataAccessTitle.style.marginBottom = '8px';
      dataAccessTitle.style.color = '#007bff';
      dataAccessTitle.style.fontWeight = '600';
      dataAccessTitle.style.display = 'flex';
      dataAccessTitle.style.justifyContent = 'space-between';
      dataAccessTitle.style.alignItems = 'center';
      dataAccessTitle.innerHTML = `
        ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹:
        <button class="btn btn-secondary btn-sm" onclick="addDataAccess(${actorIndex}, ${screenIndex})">
          <span class="icon icon-add"></span>
          ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹è¿½åŠ 
        </button>
      `;
      fieldsContainer.appendChild(dataAccessTitle);

      // ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹é …ç›®ãŒãªã„å ´åˆã¯ç©ºã®é…åˆ—ã‚’åˆæœŸåŒ–
      if (!screen.data_access) {
        screen.data_access = [];
      }

      screen.data_access.forEach((dataAccess, dataAccessIndex) => {
        const dataAccessRow = document.createElement('div');
        dataAccessRow.className = 'form-row';
        dataAccessRow.style.display = 'flex';
        dataAccessRow.style.gap = '8px';
        dataAccessRow.style.alignItems = 'center';
        
        // ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£é¸æŠç”¨ã®ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’ä½œæˆ
        const entityOptions = entitiesData.map(entity => 
          `<option value="${entity}" ${dataAccess.entity === entity ? 'selected' : ''}>${entity}</option>`
        ).join('');
        
        dataAccessRow.innerHTML = `
          <div class="form-label" style="min-width: 80px;">ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£:</div>
          <select class="form-select" onchange="updateDataAccessEntity(${actorIndex}, ${screenIndex}, ${dataAccessIndex}, this.value)" style="min-width: 140px;">
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            ${entityOptions}
          </select>
          <div class="form-label" style="min-width: 50px;">CRUD:</div>
          <label style="color: #e0e0e0; display: flex; align-items: center; gap: 4px;">
            <input type="checkbox" ${dataAccess.CRUD.includes('C') ? 'checked' : ''} 
                   onchange="updateDataAccessCRUD(${actorIndex}, ${screenIndex}, ${dataAccessIndex}, 'C', this.checked)"> C
          </label>
          <label style="color: #e0e0e0; display: flex; align-items: center; gap: 4px;">
            <input type="checkbox" ${dataAccess.CRUD.includes('R') ? 'checked' : ''} 
                   onchange="updateDataAccessCRUD(${actorIndex}, ${screenIndex}, ${dataAccessIndex}, 'R', this.checked)"> R
          </label>
          <label style="color: #e0e0e0; display: flex; align-items: center; gap: 4px;">
            <input type="checkbox" ${dataAccess.CRUD.includes('U') ? 'checked' : ''} 
                   onchange="updateDataAccessCRUD(${actorIndex}, ${screenIndex}, ${dataAccessIndex}, 'U', this.checked)"> U
          </label>
          <label style="color: #e0e0e0; display: flex; align-items: center; gap: 4px;">
            <input type="checkbox" ${dataAccess.CRUD.includes('D') ? 'checked' : ''} 
                   onchange="updateDataAccessCRUD(${actorIndex}, ${screenIndex}, ${dataAccessIndex}, 'D', this.checked)"> D
          </label>
          <button class="btn btn-danger btn-sm" onclick="deleteDataAccess(${actorIndex}, ${screenIndex}, ${dataAccessIndex})">
            <span class="icon icon-delete"></span>
          </button>
        `;
        
        fieldsContainer.appendChild(dataAccessRow);
      });

      card.appendChild(cardHeader);
      card.appendChild(fieldsContainer);
      return card;
    }

    // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¡Œã®ä½œæˆ
    function createFieldRow(field, actorIndex, screenIndex, fieldIndex) {
      const row = document.createElement('div');
      row.className = 'form-row';

      // ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³é …ç›®ã‹ã©ã†ã‹ã‚’åˆ¤å®š
      const isVariation = field.type !== 'string' && field.type !== 'number' && field.type !== 'date' && field.type !== 'time' && field.type !== 'variation' && field.type !== 'enum';

      row.innerHTML = `
        <div class="form-group">
          <input type="text" class="form-input" value="${field.é …ç›®å}" 
                 onchange="updateFieldName(${actorIndex}, ${screenIndex}, ${fieldIndex}, this.value)"
                 placeholder="é …ç›®å">
        </div>
        <div class="form-group">
          <select class="form-select" onchange="updateFieldType(${actorIndex}, ${screenIndex}, ${fieldIndex}, this.value)">
            <option value="string" ${field.type === 'string' ? 'selected' : ''}>æ–‡å­—åˆ—</option>
            <option value="number" ${field.type === 'number' ? 'selected' : ''}>æ•°å­—</option>
            <option value="date" ${field.type === 'date' ? 'selected' : ''}>æ—¥ä»˜</option>
            <option value="time" ${field.type === 'time' ? 'selected' : ''}>æ™‚é–“</option>
            <option value="enum" ${field.type === 'enum' ? 'selected' : ''}>åˆ—æŒ™å‹</option>
            <option value="variation" ${isVariation ? 'selected' : ''}>ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³</option>
          </select>
        </div>
        <div class="form-group">
          <input type="text" class="form-input" value="${field.tooltip || ''}" 
                 onchange="updateFieldTooltip(${actorIndex}, ${screenIndex}, ${fieldIndex}, this.value)"
                 placeholder="ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—">
        </div>
        <button class="btn btn-danger btn-sm" onclick="deleteField(${actorIndex}, ${screenIndex}, ${fieldIndex})">
          <span class="icon icon-delete"></span>
        </button>
      `;

      return row;
    }

    // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
    function switchTab(tabIndex) {
      // ã‚¿ãƒ–ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’æ›´æ–°
      document.querySelectorAll('.tab').forEach((tab, index) => {
        tab.classList.toggle('active', index === tabIndex);
      });

      // ãƒ‘ãƒãƒ«ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
      document.querySelectorAll('.panel').forEach((panel, index) => {
        panel.classList.toggle('hidden', index !== tabIndex);
      });
    }

    // ç”»é¢è¿½åŠ 
    function addScreen(actorIndex) {
      const newScreen = {
        screen_name: "æ–°ã—ã„ç”»é¢",
        fields: [],
        operations: [],
        data_access: []
      };

      currentBUC.actors[actorIndex].screens.push(newScreen);
      renderPanels();
    }

    // ç”»é¢å‰Šé™¤
    function deleteScreen(actorIndex, screenIndex) {
      if (confirm('ã“ã®ç”»é¢ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
        currentBUC.actors[actorIndex].screens.splice(screenIndex, 1);
        renderPanels();
      }
    }

    // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¿½åŠ 
    function addField(actorIndex, screenIndex) {
      const newField = {
        é …ç›®å: "æ–°ã—ã„é …ç›®",
        type: "string",
        tooltip: ""
      };

      currentBUC.actors[actorIndex].screens[screenIndex].fields.push(newField);
      renderPanels();
    }

    // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å‰Šé™¤
    function deleteField(actorIndex, screenIndex, fieldIndex) {
      if (confirm('ã“ã®é …ç›®ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
        currentBUC.actors[actorIndex].screens[screenIndex].fields.splice(fieldIndex, 1);
        renderPanels();
      }
    }

    // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åæ›´æ–°
    function updateFieldName(actorIndex, screenIndex, fieldIndex, value) {
      currentBUC.actors[actorIndex].screens[screenIndex].fields[fieldIndex].é …ç›®å = value;
    }

    // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚¿ã‚¤ãƒ—æ›´æ–°
    function updateFieldType(actorIndex, screenIndex, fieldIndex, value) {
      const field = currentBUC.actors[actorIndex].screens[screenIndex].fields[fieldIndex];
      
      // ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é¸æŠã—ãŸå ´åˆã€æ—¢å­˜ã®typeå€¤ã‚’ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³å€¤ã¨ã—ã¦ä¿å­˜
      if (value === 'variation') {
        // æ—¢å­˜ã®typeãŒåŸºæœ¬ã‚¿ã‚¤ãƒ—ã§ãªã„å ´åˆã€ãã‚Œã‚’ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³å€¤ã¨ã—ã¦ä¿æŒ
        if (field.type !== 'string' && field.type !== 'number' && field.type !== 'date' && field.type !== 'time' && field.type !== 'variation' && field.type !== 'enum') {
          field.variation_value = field.type; // æ—¢å­˜ã®å€¤ã‚’ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³å€¤ã¨ã—ã¦ä¿å­˜
        }
        field.type = 'variation';
      } else {
        field.type = value;
        // åŸºæœ¬ã‚¿ã‚¤ãƒ—ã«å¤‰æ›´ã—ãŸå ´åˆã€ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³å€¤ã‚’ã‚¯ãƒªã‚¢
        if (field.variation_value) {
          delete field.variation_value;
        }
      }
    }
    // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—æ›´æ–°
    function updateFieldTooltip(actorIndex, screenIndex, fieldIndex, value) {
      currentBUC.actors[actorIndex].screens[screenIndex].fields[fieldIndex].tooltip = value;
    }

    // æ“ä½œè¿½åŠ 
    function addOperation(actorIndex, screenIndex) {
      if (!currentBUC.actors[actorIndex].screens[screenIndex].operations) {
        currentBUC.actors[actorIndex].screens[screenIndex].operations = [];
      }
      currentBUC.actors[actorIndex].screens[screenIndex].operations.push("ç™»éŒ²");
      renderPanels();
    }

    // æ“ä½œå‰Šé™¤
    function deleteOperation(actorIndex, screenIndex, operationIndex) {
      if (confirm('ã“ã®æ“ä½œã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
        currentBUC.actors[actorIndex].screens[screenIndex].operations.splice(operationIndex, 1);
        renderPanels();
      }
    }

    // æ“ä½œæ›´æ–°
    function updateOperation(actorIndex, screenIndex, operationIndex, value) {
      currentBUC.actors[actorIndex].screens[screenIndex].operations[operationIndex] = value;
    }

    // ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹è¿½åŠ 
    function addDataAccess(actorIndex, screenIndex) {
      if (!currentBUC.actors[actorIndex].screens[screenIndex].data_access) {
        currentBUC.actors[actorIndex].screens[screenIndex].data_access = [];
      }
      const newDataAccess = {
        entity: "",
        CRUD: ["R"]
      };
      currentBUC.actors[actorIndex].screens[screenIndex].data_access.push(newDataAccess);
      renderPanels();
    }

    // ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹å‰Šé™¤
    function deleteDataAccess(actorIndex, screenIndex, dataAccessIndex) {
      if (confirm('ã“ã®ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
        currentBUC.actors[actorIndex].screens[screenIndex].data_access.splice(dataAccessIndex, 1);
        renderPanels();
      }
    }

    // ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£æ›´æ–°
    function updateDataAccessEntity(actorIndex, screenIndex, dataAccessIndex, value) {
      currentBUC.actors[actorIndex].screens[screenIndex].data_access[dataAccessIndex].entity = value;
    }

    // ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹CRUDæ›´æ–°
    function updateDataAccessCRUD(actorIndex, screenIndex, dataAccessIndex, crudType, checked) {
      const dataAccess = currentBUC.actors[actorIndex].screens[screenIndex].data_access[dataAccessIndex];
      if (checked) {
        if (!dataAccess.CRUD.includes(crudType)) {
          dataAccess.CRUD.push(crudType);
        }
      } else {
        dataAccess.CRUD = dataAccess.CRUD.filter(c => c !== crudType);
      }
    }

    // ç”»é¢åæ›´æ–°
    function updateScreenName(actorIndex, screenIndex, value) {
      currentBUC.actors[actorIndex].screens[screenIndex].screen_name = value;
    }

    // ãƒ‡ãƒ¼ã‚¿ä¿å­˜
    async function saveData() {
      try {
        const response = await fetch('/api/ui', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(uiData)
        });

        if (!response.ok) {
          throw new Error('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

        const result = await response.json();
        alert('ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
      } catch (error) {
        console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
        alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      }
    }

    // ã‚µãƒ¼ãƒãƒ¼ã‚’åœæ­¢ã—ã¦ç”»é¢ã‚’é–‰ã˜ã‚‹
    async function closeAndStopServer() {
      if (confirm('ã‚µãƒ¼ãƒãƒ¼ã‚’åœæ­¢ã—ã¦ç”»é¢ã‚’é–‰ã˜ã¾ã™ã‹ï¼Ÿ')) {
        try {
          // ã‚µãƒ¼ãƒãƒ¼ã«ã‚·ãƒ£ãƒƒãƒˆãƒ€ã‚¦ãƒ³ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡
          await fetch('/shutdown');
          // å°‘ã—å¾…ã£ã¦ã‹ã‚‰ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’é–‰ã˜ã‚‹
          setTimeout(() => {
            window.close();
            // window.close()ãŒå‹•ä½œã—ãªã„å ´åˆã®ä»£æ›¿ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            document.body.innerHTML = '<div style="text-align:center; padding:50px; font-size:18px; color: #ffffff;">ã‚µãƒ¼ãƒãƒ¼ãŒåœæ­¢ã—ã¾ã—ãŸã€‚<br>ã“ã®ã‚¿ãƒ–ã‚’é–‰ã˜ã¦ãã ã•ã„ã€‚</div>';
          }, 200);
        } catch (error) {
          console.error('ã‚·ãƒ£ãƒƒãƒˆãƒ€ã‚¦ãƒ³ã‚¨ãƒ©ãƒ¼:', error);
          alert('ã‚µãƒ¼ãƒãƒ¼ã®åœæ­¢ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰æ‰‹å‹•ã§åœæ­¢ã—ã¦ãã ã•ã„ã€‚');
        }
      }
    }

    // åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', () => {
      loadData();
    });
  </script>
</body>
</html> 